name: Auto Sync All Features to Dev

on:
  workflow_call:
    secrets:
      GH_TOKEN:
        required: true

jobs:
  sync-all-features-to-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "Auto Merge Bot"
          git config user.email "auto-merge@users.noreply.github.com"
          echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Get all feature branches
        id: get-features
        run: |
          # è·å–æ‰€æœ‰è¿œç¨‹ feature-* åˆ†æ”¯
          git fetch origin
          FEATURE_BRANCHES=$(git branch -r | grep -E 'origin/feature-' | sed 's/origin\///' | tr '\n' ' ')
          
          if [ -z "$FEATURE_BRANCHES" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ° feature-* åˆ†æ”¯"
            echo "feature_count=0" >> $GITHUB_OUTPUT
            echo "feature_list=" >> $GITHUB_OUTPUT
          else
            FEATURE_COUNT=$(echo "$FEATURE_BRANCHES" | wc -w)
            echo "æ‰¾åˆ° $FEATURE_COUNT ä¸ª feature åˆ†æ”¯: $FEATURE_BRANCHES"
            echo "feature_count=$FEATURE_COUNT" >> $GITHUB_OUTPUT
            echo "feature_list=$FEATURE_BRANCHES" >> $GITHUB_OUTPUT
          fi

      - name: Prepare dev branch
        id: prepare-dev
        run: |
          # æ£€æŸ¥ dev åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --exit-code --heads origin dev; then
            echo "dev åˆ†æ”¯å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨"
            git checkout dev
            git pull origin dev
            echo "use_existing_dev=true" >> $GITHUB_OUTPUT
          else
            echo "dev åˆ†æ”¯ä¸å­˜åœ¨ï¼Œä» main åˆ›å»º"
            git checkout main
            git pull origin main
            git checkout -b dev
            echo "use_existing_dev=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge all feature branches
        if: steps.get-features.outputs.feature_count != '0'
        id: merge-features
        env:
          FEATURE_BRANCHES: ${{ steps.get-features.outputs.feature_list }}
        run: |
          echo "ğŸ”„ åˆå¹¶æ‰€æœ‰ feature åˆ†æ”¯åˆ° dev..."
          echo "è¦åˆå¹¶çš„åˆ†æ”¯: $FEATURE_BRANCHES"
          
          MERGE_SUCCESS="true"
          CONFLICT_BRANCHES=""
          MERGED_BRANCHES=""
          SKIPPED_BRANCHES=""
          
          for branch in $FEATURE_BRANCHES; do
            echo "--------------------------------------------------"
            echo "ğŸ“¦ å¤„ç†åˆ†æ”¯: $branch"
            
            # ç¡®ä¿è·å–æœ€æ–°çš„åˆ†æ”¯
            git fetch origin $branch
            
            # å°è¯•åˆå¹¶
            if git merge origin/$branch --no-ff -m "Auto-merge: $branch â†’ dev"; then
              # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
              if git diff HEAD@{1} HEAD --quiet; then
                echo "â„¹ï¸ $branch æ— æ–°å˜æ›´ï¼ˆAlready up-to-dateï¼‰"
                SKIPPED_BRANCHES="$SKIPPED_BRANCHES $branch"
              else
                echo "âœ… $branch åˆå¹¶æˆåŠŸï¼ˆæœ‰æ–°å˜æ›´ï¼‰"
                MERGED_BRANCHES="$MERGED_BRANCHES $branch"
              fi
            else
              echo "âŒ $branch åˆå¹¶å†²çª"
              MERGE_SUCCESS="false"
              CONFLICT_BRANCHES="$CONFLICT_BRANCHES $branch"
              
              # è®°å½•å†²çªæ–‡ä»¶
              CONFLICT_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "æ— æ³•è·å–å†²çªæ–‡ä»¶")
              echo "å†²çªæ–‡ä»¶: $CONFLICT_FILES"
              
              # ä¸­æ­¢åˆå¹¶
              git merge --abort
            fi
          done
          
          echo "merge_success=$MERGE_SUCCESS" >> $GITHUB_OUTPUT
          echo "conflict_branches=$CONFLICT_BRANCHES" >> $GITHUB_OUTPUT
          echo "merged_branches=$MERGED_BRANCHES" >> $GITHUB_OUTPUT
          echo "skipped_branches=$SKIPPED_BRANCHES" >> $GITHUB_OUTPUT
          
          if [ "$MERGE_SUCCESS" = "true" ]; then
            echo "ğŸ‰ æ‰€æœ‰ feature åˆ†æ”¯å¤„ç†å®Œæˆ"
            echo "æœ‰å˜æ›´çš„: $MERGED_BRANCHES"
            echo "æ— å˜æ›´çš„: $SKIPPED_BRANCHES"
          else
            echo "âš ï¸ éƒ¨åˆ†åˆ†æ”¯åˆå¹¶æ—¶å‘ç”Ÿå†²çª"
          fi

      - name: Push dev branch
        if: steps.get-features.outputs.feature_count != '0' && steps.merge-features.outputs.merge_success == 'true'
        env:
          MERGED_BRANCHES: ${{ steps.merge-features.outputs.merged_branches }}
          SKIPPED_BRANCHES: ${{ steps.merge-features.outputs.skipped_branches }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´éœ€è¦æ¨é€
          if git diff origin/dev HEAD --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰å®é™…å˜æ›´ï¼Œè·³è¿‡æ¨é€"
          else
            echo "ğŸš€ æ¨é€ dev åˆ†æ”¯..."
            git push origin dev
            
            echo "âœ¨ dev åˆ†æ”¯æ›´æ–°å®Œæˆ"
            echo "åŸºäºåˆ†æ”¯: ${{ steps.prepare-dev.outputs.use_existing_dev == 'true' && 'ç°æœ‰ dev' || 'main' }}"
            echo "å®é™…åˆå¹¶çš„åˆ†æ”¯: $MERGED_BRANCHES"
            echo "è·³è¿‡çš„åˆ†æ”¯ï¼ˆå·²åˆå¹¶æˆ–æ— å˜æ›´ï¼‰: $SKIPPED_BRANCHES"
            echo "æ—¶é—´: $(date)"
          fi

      - name: Handle merge conflicts
        if: steps.get-features.outputs.feature_count != '0' && steps.merge-features.outputs.merge_success == 'false'
        env:
          CONFLICT_BRANCHES: ${{ steps.merge-features.outputs.conflict_branches }}
          MERGED_BRANCHES: ${{ steps.merge-features.outputs.merged_branches }}
          SKIPPED_BRANCHES: ${{ steps.merge-features.outputs.skipped_branches }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "ğŸ“ å¤„ç†åˆå¹¶å†²çª..."
          
          # å…ˆæ¨é€å·²æˆåŠŸåˆå¹¶çš„éƒ¨åˆ†ï¼ˆå¦‚æœæœ‰ï¼‰
          if [ -n "$MERGED_BRANCHES" ]; then
            echo "æ¨é€å·²æˆåŠŸåˆå¹¶çš„éƒ¨åˆ†..."
            git push origin dev
            echo "âœ… å·²æ¨é€æˆåŠŸåˆå¹¶çš„éƒ¨åˆ†"
          fi
          
          # åˆ›å»ºå†²çªæŠ¥å‘Š PR
          CONFLICT_BRANCH="dev-conflict-$(date +%s)"
          git checkout -b $CONFLICT_BRANCH
          git push -u origin $CONFLICT_BRANCH
          
          gh pr create \
            --base dev \
            --head $CONFLICT_BRANCH \
            --title "ğŸš¨ Merge Conflicts: Some Feature Branches â†’ Dev" \
            --body "## éƒ¨åˆ†åˆå¹¶å®Œæˆï¼Œä½†æœ‰å†²çª\n\n**æˆåŠŸåˆå¹¶çš„åˆ†æ”¯ï¼š**\n- $(echo $MERGED_BRANCHES | sed 's/ /\n- /g')\n\n**è·³è¿‡çš„åˆ†æ”¯ï¼ˆæ— å˜æ›´ï¼‰ï¼š**\n- $(echo $SKIPPED_BRANCHES | sed 's/ /\n- /g')\n\n**å†²çªåˆ†æ”¯ï¼š**\n- $(echo $CONFLICT_BRANCHES | sed 's/ /\n- /g')\n\n**è¯´æ˜ï¼š**\n1. å·²æˆåŠŸåˆå¹¶çš„éƒ¨åˆ†å·²æ¨é€åˆ° dev åˆ†æ”¯\n2. è¯·è§£å†³å†²çªååˆå¹¶æ­¤ PR åˆ° dev" \
            --label "needs-attention"
          
          echo "âš ï¸ éƒ¨åˆ†åˆ†æ”¯åˆå¹¶å†²çª"
          echo "å·²æˆåŠŸåˆå¹¶: $MERGED_BRANCHES"
          echo "å†²çªåˆ†æ”¯: $CONFLICT_BRANCHES"
          echo "å·²åˆ›å»º PR å¤„ç†å†²çª"

      - name: No features notification
        if: steps.get-features.outputs.feature_count == '0'
        run: |
          echo "ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• feature-* åˆ†æ”¯"
          
          # å¦‚æœ dev åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„ï¼ˆåŸºäº mainï¼‰
          if [ "${{ steps.prepare-dev.outputs.use_existing_dev }}" = "false" ]; then
            echo "åˆ›å»ºç©ºçš„ dev åˆ†æ”¯..."
            git push -u origin dev
            echo "âœ… å·²åˆ›å»º dev åˆ†æ”¯ï¼ˆæ—  feature å†…å®¹ï¼‰"
          else
            echo "â„¹ï¸ dev åˆ†æ”¯å·²å­˜åœ¨ï¼Œæ— éœ€æ“ä½œ"
          fi
