name: Auto Sync All Features to Dev

on:
  workflow_call:
    secrets:
      GH_TOKEN:
        required: true

jobs:
  sync-all-features-to-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Git and GitHub CLI
        run: |
          git config user.name "Auto Merge Bot"
          git config user.email "auto-merge@users.noreply.github.com"
          echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Get all feature branches
        id: get-features
        run: |
          # è·å–æ‰€æœ‰è¿œç¨‹ feature-* åˆ†æ”¯
          git fetch origin
          FEATURE_BRANCHES=$(git branch -r | grep -E 'origin/feature-' | sed 's/origin\///' | tr '\n' ' ')
          
          if [ -z "$FEATURE_BRANCHES" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ° feature-* åˆ†æ”¯"
            echo "feature_count=0" >> $GITHUB_OUTPUT
            echo "feature_list=" >> $GITHUB_OUTPUT
          else
            FEATURE_COUNT=$(echo "$FEATURE_BRANCHES" | wc -w)
            echo "æ‰¾åˆ° $FEATURE_COUNT ä¸ª feature åˆ†æ”¯: $FEATURE_BRANCHES"
            echo "feature_count=$FEATURE_COUNT" >> $GITHUB_OUTPUT
            echo "feature_list=$FEATURE_BRANCHES" >> $GITHUB_OUTPUT
          fi

      - name: Recreate dev branch from main
        if: steps.get-features.outputs.feature_count != '0'
        run: |
          echo "ğŸ”„ ä» main åˆ†æ”¯é‡æ–°åˆ›å»º dev åˆ†æ”¯..."
          
          # ç¡®ä¿ main åˆ†æ”¯æ˜¯æœ€æ–°çš„
          git checkout main
          git pull origin main
          
          # åˆ é™¤æœ¬åœ°çš„ dev åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git branch -D dev 2>/dev/null || true
          
          # åˆ é™¤è¿œç¨‹çš„ dev åˆ†æ”¯
          git push origin --delete dev 2>/dev/null || echo "è¿œç¨‹ dev åˆ†æ”¯ä¸å­˜åœ¨æˆ–æ— æ³•åˆ é™¤"
          
          # ä» main åˆ›å»ºæ–°çš„ dev åˆ†æ”¯
          git checkout -b dev
          
          echo "âœ… å·²åˆ›å»ºæ–°çš„ dev åˆ†æ”¯ï¼ˆåŸºäºæœ€æ–° mainï¼‰"

      - name: Merge all feature branches
        if: steps.get-features.outputs.feature_count != '0'
        id: merge-features
        env:
          FEATURE_BRANCHES: ${{ steps.get-features.outputs.feature_list }}
        run: |
          echo "ğŸ”„ å¼€å§‹åˆå¹¶æ‰€æœ‰ feature åˆ†æ”¯åˆ° dev..."
          echo "è¦åˆå¹¶çš„åˆ†æ”¯: $FEATURE_BRANCHES"
          
          MERGE_SUCCESS="true"
          CONFLICT_BRANCHES=""
          
          for branch in $FEATURE_BRANCHES; do
            echo "--------------------------------------------------"
            echo "ğŸ“¦ å¤„ç†åˆ†æ”¯: $branch"
            
            # ç¡®ä¿è·å–æœ€æ–°çš„åˆ†æ”¯
            git fetch origin $branch
            
            # å°è¯•åˆå¹¶
            if git merge origin/$branch --no-ff -m "Auto-merge: $branch â†’ dev"; then
              echo "âœ… $branch åˆå¹¶æˆåŠŸ"
            else
              echo "âŒ $branch åˆå¹¶å†²çª"
              MERGE_SUCCESS="false"
              CONFLICT_BRANCHES="$CONFLICT_BRANCHES $branch"
              
              # è®°å½•å†²çªæ–‡ä»¶
              CONFLICT_FILES=$(git diff --name-only --diff-filter=U || echo "æ— æ³•è·å–å†²çªæ–‡ä»¶")
              echo "å†²çªæ–‡ä»¶: $CONFLICT_FILES"
              
              # ä¸­æ­¢åˆå¹¶
              git merge --abort
            fi
          done
          
          echo "merge_success=$MERGE_SUCCESS" >> $GITHUB_OUTPUT
          echo "conflict_branches=$CONFLICT_BRANCHES" >> $GITHUB_OUTPUT
          
          if [ "$MERGE_SUCCESS" = "true" ]; then
            echo "ğŸ‰ æ‰€æœ‰ feature åˆ†æ”¯åˆå¹¶æˆåŠŸï¼"
          else
            echo "âš ï¸ éƒ¨åˆ†åˆ†æ”¯åˆå¹¶æ—¶å‘ç”Ÿå†²çª"
          fi

      - name: Push dev branch or create conflict PR
        if: steps.get-features.outputs.feature_count != '0'
        env:
          CONFLICT_BRANCHES: ${{ steps.merge-features.outputs.conflict_branches }}
        run: |
          if [ "${{ steps.merge-features.outputs.merge_success }}" = "true" ]; then
            # æ‰€æœ‰åˆ†æ”¯åˆå¹¶æˆåŠŸï¼Œæ¨é€ dev åˆ†æ”¯
            echo "ğŸš€ æ¨é€æ–°çš„ dev åˆ†æ”¯åˆ°è¿œç¨‹..."
            git push -u origin dev --force
            
            echo "âœ¨ è‡ªåŠ¨åŒæ­¥å®Œæˆ"
            echo "åŸºäºåˆ†æ”¯: main"
            echo "åˆå¹¶çš„ feature åˆ†æ”¯: ${{ steps.get-features.outputs.feature_list }}"
            echo "æ—¶é—´: $(date)"
          else
            # æœ‰å†²çªï¼Œåˆ›å»º PR æé†’
            echo "ğŸ“ åˆ›å»ºå†²çªæé†’ PR..."
            
            # å…ˆä¿å­˜å½“å‰æœ‰å†²çªçš„ dev åˆ†æ”¯
            git add .
            git commit -m "WIP: Partial merge with conflicts" || echo "æ— å†…å®¹å¯æäº¤"
            
            # æ¨é€å½“å‰æœ‰å†²çªçš„çŠ¶æ€åˆ°ä¸´æ—¶åˆ†æ”¯
            TEMP_BRANCH="dev-with-conflicts-$(date +%s)"
            git checkout -b $TEMP_BRANCH
            git push -u origin $TEMP_BRANCH
            
            # åˆ›å»º PR
            gh pr create \
              --base main \
              --head $TEMP_BRANCH \
              --title "ğŸš¨ Merge Conflicts: Feature branches â†’ New Dev" \
              --body "## è‡ªåŠ¨åˆå¹¶å¤±è´¥\n\nä»¥ä¸‹ feature åˆ†æ”¯åˆå¹¶åˆ°æ–°çš„ dev åˆ†æ”¯æ—¶å‘ç”Ÿå†²çªï¼š\n\n**å†²çªåˆ†æ”¯ï¼š**\n- $(echo $CONFLICT_BRANCHES | sed 's/ /\n- /g')\n\n**è§£å†³æ–¹æ¡ˆï¼š**\n1. æ‰‹åŠ¨è§£å†³å†²çª\n2. åˆ é™¤æ—§çš„ dev åˆ†æ”¯\n3. å°†æ­¤åˆ†æ”¯é‡å‘½åä¸º dev æˆ–é‡æ–°åˆ›å»º dev åˆ†æ”¯\n\n**è¯´æ˜ï¼š**\n- æ­¤ dev åˆ†æ”¯æ˜¯åŸºäºæœ€æ–° main åˆ†æ”¯é‡æ–°åˆ›å»ºçš„\n- åªåˆå¹¶äº†å½“å‰å­˜åœ¨çš„æ‰€æœ‰ feature-* åˆ†æ”¯\n- å·²åˆ é™¤çš„ feature åˆ†æ”¯ä¸ä¼šåŒ…å«åœ¨å†…" \
              --label "needs-attention"
            
            # åˆ é™¤è¿œç¨‹ dev åˆ†æ”¯ï¼ˆä¿æŒä¸ºç©ºï¼‰
            git push origin --delete dev 2>/dev/null || echo "è¿œç¨‹ dev åˆ†æ”¯å·²è¢«åˆ é™¤æˆ–ä¸å­˜åœ¨"
            
            echo "âš ï¸ ç”±äºåˆå¹¶å†²çªï¼Œdev åˆ†æ”¯æœªæ›´æ–°"
            echo "å·²åˆ›å»ºå†²çªå¤„ç†åˆ†æ”¯: $TEMP_BRANCH"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: No features notification
        if: steps.get-features.outputs.feature_count == '0'
        run: |
          echo "ğŸ“­ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• feature-* åˆ†æ”¯"
          echo "åˆ é™¤ dev åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰..."
          
          # åˆ é™¤ dev åˆ†æ”¯ï¼Œä¿æŒä¸ main åŒæ­¥
          git push origin --delete dev 2>/dev/null || echo "è¿œç¨‹ dev åˆ†æ”¯ä¸å­˜åœ¨"
          
          echo "âœ… å·²æ¸…ç† dev åˆ†æ”¯ï¼Œå› ä¸ºæ²¡æœ‰ feature åˆ†æ”¯éœ€è¦åˆå¹¶"
