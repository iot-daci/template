name: Auto Sync All Features to Dev

on:
  workflow_call:
    secrets:
      GH_TOKEN:
        required: true

jobs:
  sync-all-features-to-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Record build start time
        run: echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "Auto Merge Bot"
          git config user.email "auto-merge@users.noreply.github.com"
          echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Get all branches to merge
        id: get-branches
        run: |
          # 获取所有远程 feature-* 分支
          git fetch origin
          FEATURE_BRANCHES=$(git branch -r | grep -E 'origin/feature-' | sed 's/origin\///' | tr '\n' ' ')
          
          # 添加 main 分支到合并列表
          ALL_BRANCHES_TO_MERGE="$FEATURE_BRANCHES main"
          
          # 去除重复和空值
          ALL_BRANCHES_TO_MERGE=$(echo "$ALL_BRANCHES_TO_MERGE" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          
          if [ -z "$FEATURE_BRANCHES" ] && [ -z "$ALL_BRANCHES_TO_MERGE" ]; then
            echo "没有找到需要合并的分支"
            echo "branch_count=0" >> $GITHUB_OUTPUT
            echo "branch_list=" >> $GITHUB_OUTPUT
          else
            BRANCH_COUNT=$(echo "$ALL_BRANCHES_TO_MERGE" | wc -w)
            echo "找到 $BRANCH_COUNT 个需要合并的分支: $ALL_BRANCHES_TO_MERGE"
            echo "branch_count=$BRANCH_COUNT" >> $GITHUB_OUTPUT
            echo "branch_list=$ALL_BRANCHES_TO_MERGE" >> $GITHUB_OUTPUT
          fi

      - name: Prepare dev branch
        id: prepare-dev
        run: |
          # 检查 dev 分支是否存在
          if git ls-remote --exit-code --heads origin dev; then
            echo "dev 分支存在，直接使用"
            git checkout dev
            git pull origin dev
            echo "use_existing_dev=true" >> $GITHUB_OUTPUT
          else
            echo "dev 分支不存在，从 main 创建"
            git checkout main
            git pull origin main
            git checkout -b dev
            echo "use_existing_dev=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge all branches
        if: steps.get-branches.outputs.branch_count != '0'
        id: merge-branches
        env:
          ALL_BRANCHES: ${{ steps.get-branches.outputs.branch_list }}
        run: |
          echo "🔄 合并所有分支到 dev..."
          echo "要合并的分支: $ALL_BRANCHES"
          
          MERGE_SUCCESS="true"
          CONFLICT_BRANCHES=""
          MERGED_BRANCHES=""
          SKIPPED_BRANCHES=""
          CONFLICT_DETAILS=""
          
          for branch in $ALL_BRANCHES; do
            echo "--------------------------------------------------"
            echo "📦 处理分支: $branch"
            
            # 确保获取最新的分支
            git fetch origin $branch
            
            # 尝试合并
            if git merge origin/$branch --no-ff -m "Auto-merge: $branch → dev"; then
              # 检查是否有实际变更
              if git diff HEAD@{1} HEAD --quiet; then
                echo "ℹ️ $branch 无新变更（Already up-to-date）"
                SKIPPED_BRANCHES="$SKIPPED_BRANCHES $branch"
              else
                echo "✅ $branch 合并成功（有新变更）"
                MERGED_BRANCHES="$MERGED_BRANCHES $branch"
              fi
            else
              echo "❌ $branch 合并冲突"
              MERGE_SUCCESS="false"
              CONFLICT_BRANCHES="$CONFLICT_BRANCHES $branch"
              
              # 记录冲突文件
              CONFLICT_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "无法获取冲突文件")
              echo "冲突文件: $CONFLICT_FILES"
              
              # 保存冲突详情
              if [ -n "$CONFLICT_DETAILS" ]; then
                CONFLICT_DETAILS="$CONFLICT_DETAILS\n"
              fi
              CONFLICT_DETAILS="${CONFLICT_DETAILS}分支 \`$branch\`: $CONFLICT_FILES"
              
              # 中止合并
              git merge --abort
            fi
          done
          
          echo "merge_success=$MERGE_SUCCESS" >> $GITHUB_OUTPUT
          echo "conflict_branches=$CONFLICT_BRANCHES" >> $GITHUB_OUTPUT
          echo "merged_branches=$MERGED_BRANCHES" >> $GITHUB_OUTPUT
          echo "skipped_branches=$SKIPPED_BRANCHES" >> $GITHUB_OUTPUT
          echo "conflict_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CONFLICT_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "$MERGE_SUCCESS" = "true" ]; then
            echo "🎉 所有分支处理完成"
            echo "有变更的: $MERGED_BRANCHES"
            echo "无变更的: $SKIPPED_BRANCHES"
          else
            echo "⚠️ 部分分支合并时发生冲突"
            # 关键：冲突时立即退出并失败
            echo "::error::合并冲突，请查看 Summary 了解详情"
            exit 1
          fi

      - name: Push dev branch
        if: steps.get-branches.outputs.branch_count != '0' && steps.merge-branches.outputs.merge_success == 'true'
        env:
          MERGED_BRANCHES: ${{ steps.merge-branches.outputs.merged_branches }}
          SKIPPED_BRANCHES: ${{ steps.merge-branches.outputs.skipped_branches }}
        run: |
          # 检查是否有实际变更需要推送
          if git diff origin/dev HEAD --quiet; then
            echo "ℹ️ 没有实际变更，跳过推送"
          else
            echo "🚀 推送 dev 分支..."
            git push origin dev
            
            echo "✨ dev 分支更新完成"
            echo "基于分支: ${{ steps.prepare-dev.outputs.use_existing_dev == 'true' && '现有 dev' || 'main' }}"
            echo "实际合并的分支: $MERGED_BRANCHES"
            echo "跳过的分支（已合并或无变更）: $SKIPPED_BRANCHES"
            echo "时间: $(date)"
          fi

      - name: Handle merge conflicts (info only)
        if: steps.get-branches.outputs.branch_count != '0' && steps.merge-branches.outputs.merge_success == 'false'
        env:
          CONFLICT_BRANCHES: ${{ steps.merge-branches.outputs.conflict_branches }}
          MERGED_BRANCHES: ${{ steps.merge-branches.outputs.merged_branches }}
          SKIPPED_BRANCHES: ${{ steps.merge-branches.outputs.skipped_branches }}
        run: |
          echo "📝 冲突处理信息..."
          
          # 先推送已成功合并的部分（如果有）
          if [ -n "$MERGED_BRANCHES" ]; then
            echo "推送已成功合并的部分..."
            git push origin dev
            echo "✅ 已推送成功合并的部分"
          fi
          
          echo "⚠️ 部分分支合并冲突"
          echo "已成功合并: $MERGED_BRANCHES"
          echo "冲突分支: $CONFLICT_BRANCHES"
          echo "请查看 Summary 了解详细冲突信息和解决方法"

      - name: No branches notification
        if: steps.get-branches.outputs.branch_count == '0'
        run: |
          echo "📭 没有找到需要合并的分支"
          
          # 如果 dev 分支不存在，创建一个空的（基于 main）
          if [ "${{ steps.prepare-dev.outputs.use_existing_dev }}" = "false" ]; then
            echo "创建空的 dev 分支..."
            git push -u origin dev
            echo "✅ 已创建 dev 分支（无 feature 内容）"
          else
            echo "ℹ️ dev 分支已存在，无需操作"
          fi

      - name: Summary
        if: always()
        env:
          JOB_STATUS: ${{ job.status }}
          BUILD_START_TIME: ${{ env.BUILD_START_TIME }}
        run: |
          BUILD_END_TIME=$(date +%s)
          BUILD_START=${BUILD_START_TIME:-$BUILD_END_TIME}
          BUILD_DURATION=$((BUILD_END_TIME - BUILD_START))
          BUILD_MINUTES=$((BUILD_DURATION / 60))
          BUILD_SECONDS=$((BUILD_DURATION % 60))
          
          echo "## 🔄 Auto Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # 根据不同的情况显示不同的状态
          if [ "${{ steps.get-branches.outputs.branch_count }}" = "0" ]; then
            echo "ℹ️ **状态:** 没有找到需要合并的分支" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.prepare-dev.outputs.use_existing_dev }}" = "false" ]; then
              echo "✅ 已创建空的 dev 分支（基于 main）" >> $GITHUB_STEP_SUMMARY
            else
              echo "ℹ️ dev 分支已存在，无需操作" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ steps.merge-branches.outputs.merge_success }}" = "true" ]; then
            echo "✅ **状态:** 所有分支合并成功！" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**合并结果:**" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.merge-branches.outputs.merged_branches }}" ]; then
              echo "- ✅ 成功合并的分支: \`${{ steps.merge-branches.outputs.merged_branches }}\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "${{ steps.merge-branches.outputs.skipped_branches }}" ]; then
              echo "- ⏭️ 跳过的分支（无变更）: \`${{ steps.merge-branches.outputs.skipped_branches }}\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Dev 分支信息:**" >> $GITHUB_STEP_SUMMARY
            echo "- 基于: \`${{ steps.prepare-dev.outputs.use_existing_dev == 'true' && '现有 dev' || 'main' }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- 已推送到远程仓库" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.merge-branches.outputs.merge_success }}" = "false" ]; then
            echo "❌ **状态:** ❌ 合并冲突 - Workflow 失败" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**合并结果:**" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.merge-branches.outputs.merged_branches }}" ]; then
              echo "- ✅ 成功合并的分支: \`${{ steps.merge-branches.outputs.merged_branches }}\`" >> $GITHUB_STEP_SUMMARY
              echo "  (已推送到 dev 分支)" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "${{ steps.merge-branches.outputs.skipped_branches }}" ]; then
              echo "- ⏭️ 跳过的分支（无变更）: \`${{ steps.merge-branches.outputs.skipped_branches }}\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "${{ steps.merge-branches.outputs.conflict_branches }}" ]; then
              echo "- ❌ 冲突分支: \`${{ steps.merge-branches.outputs.conflict_branches }}\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**冲突详情:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.merge-branches.outputs.conflict_details }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**解决方案:**" >> $GITHUB_STEP_SUMMARY
            echo "1. ✅ 已成功合并的部分已推送到 \`dev\` 分支" >> $GITHUB_STEP_SUMMARY
            echo "2. ❌ 请按以下步骤解决冲突分支:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**解决冲突的方法:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# 1. 检出 dev 分支" >> $GITHUB_STEP_SUMMARY
            echo "git checkout dev" >> $GITHUB_STEP_SUMMARY
            echo "git pull origin dev" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# 2. 合并冲突分支（例如: feature-xxx）" >> $GITHUB_STEP_SUMMARY
            echo "git merge origin/feature-xxx" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# 3. 查看冲突文件" >> $GITHUB_STEP_SUMMARY
            echo "git status" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# 4. 手动编辑冲突文件，解决冲突标记（<<<<<<, ======, >>>>>>）" >> $GITHUB_STEP_SUMMARY
            echo "# 编辑冲突文件..." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# 5. 标记冲突已解决并提交" >> $GITHUB_STEP_SUMMARY
            echo "git add <冲突文件>" >> $GITHUB_STEP_SUMMARY
            echo "git commit -m \"Resolve merge conflicts with feature-xxx\"" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# 6. 推送到远程" >> $GITHUB_STEP_SUMMARY
            echo "git push origin dev" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**提示:**" >> $GITHUB_STEP_SUMMARY
            echo "- 冲突文件位置已在上方冲突详情中列出" >> $GITHUB_STEP_SUMMARY
            echo "- 解决冲突后，可以重新运行此工作流来合并剩余分支" >> $GITHUB_STEP_SUMMARY
            echo "- **⚠️ 重要: 此工作流因冲突而失败，需要手动解决冲突后才能继续**" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **状态:** 工作流执行异常" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**执行信息:**" >> $GITHUB_STEP_SUMMARY
          echo "- 分支数量: \`${{ steps.get-branches.outputs.branch_count }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- 执行时长: \`${BUILD_MINUTES}m ${BUILD_SECONDS}s\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Ref: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
