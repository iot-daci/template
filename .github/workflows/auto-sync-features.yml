name: Auto Sync All Features to Dev

on:
  workflow_call:
    secrets:
      GH_TOKEN:
        required: true

jobs:
  sync-all-features-to-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "Auto Merge Bot"
          git config user.email "auto-merge@users.noreply.github.com"
          echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Get all branches to merge
        id: get-branches
        run: |
          # è·å–æ‰€æœ‰è¿œç¨‹ feature-* åˆ†æ”¯
          git fetch origin
          FEATURE_BRANCHES=$(git branch -r | grep -E 'origin/feature-' | sed 's/origin\///' | tr '\n' ' ')
          
          # æ·»åŠ  main åˆ†æ”¯åˆ°åˆå¹¶åˆ—è¡¨
          ALL_BRANCHES_TO_MERGE="$FEATURE_BRANCHES main"
          
          # å»é™¤é‡å¤å’Œç©ºå€¼
          ALL_BRANCHES_TO_MERGE=$(echo "$ALL_BRANCHES_TO_MERGE" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          
          if [ -z "$FEATURE_BRANCHES" ] && [ -z "$ALL_BRANCHES_TO_MERGE" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆå¹¶çš„åˆ†æ”¯"
            echo "branch_count=0" >> $GITHUB_OUTPUT
            echo "branch_list=" >> $GITHUB_OUTPUT
          else
            BRANCH_COUNT=$(echo "$ALL_BRANCHES_TO_MERGE" | wc -w)
            echo "æ‰¾åˆ° $BRANCH_COUNT ä¸ªéœ€è¦åˆå¹¶çš„åˆ†æ”¯: $ALL_BRANCHES_TO_MERGE"
            echo "branch_count=$BRANCH_COUNT" >> $GITHUB_OUTPUT
            echo "branch_list=$ALL_BRANCHES_TO_MERGE" >> $GITHUB_OUTPUT
          fi

      - name: Prepare dev branch
        id: prepare-dev
        run: |
          # æ£€æŸ¥ dev åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --exit-code --heads origin dev; then
            echo "dev åˆ†æ”¯å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨"
            git checkout dev
            git pull origin dev
            echo "use_existing_dev=true" >> $GITHUB_OUTPUT
          else
            echo "dev åˆ†æ”¯ä¸å­˜åœ¨ï¼Œä» main åˆ›å»º"
            git checkout main
            git pull origin main
            git checkout -b dev
            echo "use_existing_dev=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge all branches
        if: steps.get-branches.outputs.branch_count != '0'
        id: merge-branches
        env:
          ALL_BRANCHES: ${{ steps.get-branches.outputs.branch_list }}
        run: |
          echo "ğŸ”„ åˆå¹¶æ‰€æœ‰åˆ†æ”¯åˆ° dev..."
          echo "è¦åˆå¹¶çš„åˆ†æ”¯: $ALL_BRANCHES"
          
          MERGE_SUCCESS="true"
          CONFLICT_BRANCHES=""
          CONFLICT_DETAILS=""
          MERGED_BRANCHES=""
          SKIPPED_BRANCHES=""
          
          for branch in $ALL_BRANCHES; do
            echo "--------------------------------------------------"
            echo "ğŸ“¦ å¤„ç†åˆ†æ”¯: $branch"
            
            # ç¡®ä¿è·å–æœ€æ–°çš„åˆ†æ”¯
            git fetch origin $branch
            
            # å°è¯•åˆå¹¶
            if git merge origin/$branch --no-ff -m "Auto-merge: $branch â†’ dev"; then
              # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
              if git diff HEAD@{1} HEAD --quiet; then
                echo "â„¹ï¸ $branch æ— æ–°å˜æ›´ï¼ˆAlready up-to-dateï¼‰"
                SKIPPED_BRANCHES="$SKIPPED_BRANCHES $branch"
              else
                echo "âœ… $branch åˆå¹¶æˆåŠŸï¼ˆæœ‰æ–°å˜æ›´ï¼‰"
                MERGED_BRANCHES="$MERGED_BRANCHES $branch"
              fi
            else
              echo "âŒ $branch åˆå¹¶å†²çª"
              MERGE_SUCCESS="false"
              CONFLICT_BRANCHES="$CONFLICT_BRANCHES $branch"
              
              # è·å–è¯¦ç»†çš„å†²çªä¿¡æ¯
              echo "è·å–å†²çªè¯¦æƒ…..."
              CONFLICT_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "æ— æ³•è·å–å†²çªæ–‡ä»¶")
              
              # è·å–å†²çªçš„å…·ä½“å†…å®¹
              CONFLICT_CONTENT=""
              for file in $CONFLICT_FILES; do
                if [ -f "$file" ]; then
                  CONFLICT_SNIPPET=$(grep -n '^<<<<<<<' "$file" | head -3 | sed 's/^/    è¡Œ /')
                  if [ -n "$CONFLICT_SNIPPET" ]; then
                    CONFLICT_CONTENT="$CONFLICT_CONTENT\næ–‡ä»¶: $file\nå†²çªä½ç½®:\n$CONFLICT_SNIPPET"
                  fi
                fi
              done
              
              # è®°å½•å†²çªè¯¦æƒ…
              BRANCH_DETAILS="åˆ†æ”¯: $branch\nå†²çªæ–‡ä»¶: $CONFLICT_FILES\n$CONFLICT_CONTENT\n"
              CONFLICT_DETAILS="$CONFLICT_DETAILS\n$BRANCH_DETAILS"
              
              echo "å†²çªæ–‡ä»¶: $CONFLICT_FILES"
              
              # ä¸­æ­¢åˆå¹¶
              git merge --abort
            fi
          done
          
          echo "merge_success=$MERGE_SUCCESS" >> $GITHUB_OUTPUT
          echo "conflict_branches=$CONFLICT_BRANCHES" >> $GITHUB_OUTPUT
          echo "conflict_details<<EOF" >> $GITHUB_OUTPUT
          echo "$CONFLICT_DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "merged_branches=$MERGED_BRANCHES" >> $GITHUB_OUTPUT
          echo "skipped_branches=$SKIPPED_BRANCHES" >> $GITHUB_OUTPUT
          
          if [ "$MERGE_SUCCESS" = "true" ]; then
            echo "ğŸ‰ æ‰€æœ‰åˆ†æ”¯å¤„ç†å®Œæˆ"
            echo "æœ‰å˜æ›´çš„: $MERGED_BRANCHES"
            echo "æ— å˜æ›´çš„: $SKIPPED_BRANCHES"
          else
            echo "âš ï¸ éƒ¨åˆ†åˆ†æ”¯åˆå¹¶æ—¶å‘ç”Ÿå†²çª"
          fi

      - name: Push dev branch
        if: steps.get-branches.outputs.branch_count != '0' && steps.merge-branches.outputs.merge_success == 'true'
        env:
          MERGED_BRANCHES: ${{ steps.merge-branches.outputs.merged_branches }}
          SKIPPED_BRANCHES: ${{ steps.merge-branches.outputs.skipped_branches }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´éœ€è¦æ¨é€
          if git diff origin/dev HEAD --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰å®é™…å˜æ›´ï¼Œè·³è¿‡æ¨é€"
          else
            echo "ğŸš€ æ¨é€ dev åˆ†æ”¯..."
            git push origin dev
            
            echo "âœ¨ dev åˆ†æ”¯æ›´æ–°å®Œæˆ"
            echo "åŸºäºåˆ†æ”¯: ${{ steps.prepare-dev.outputs.use_existing_dev == 'true' && 'ç°æœ‰ dev' || 'main' }}"
            echo "å®é™…åˆå¹¶çš„åˆ†æ”¯: $MERGED_BRANCHES"
            echo "è·³è¿‡çš„åˆ†æ”¯ï¼ˆå·²åˆå¹¶æˆ–æ— å˜æ›´ï¼‰: $SKIPPED_BRANCHES"
            echo "æ—¶é—´: $(date)"
          fi

      - name: Handle merge conflicts
        if: steps.get-branches.outputs.branch_count != '0' && steps.merge-branches.outputs.merge_success == 'false'
        env:
          CONFLICT_BRANCHES: ${{ steps.merge-branches.outputs.conflict_branches }}
          CONFLICT_DETAILS: ${{ steps.merge-branches.outputs.conflict_details }}
          MERGED_BRANCHES: ${{ steps.merge-branches.outputs.merged_branches }}
          SKIPPED_BRANCHES: ${{ steps.merge-branches.outputs.skipped_branches }}
        run: |
          echo " "
          echo "âŒâŒâŒ åˆå¹¶å†²çª âŒâŒâŒ"
          echo "========================================"
          echo "âš ï¸ è‡ªåŠ¨åˆå¹¶å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†å†²çª"
          echo " "
          echo "ğŸ“‹ å†²çªåˆ†æ”¯:"
          for branch in $CONFLICT_BRANCHES; do
            echo "  â€¢ $branch"
          done
          echo " "
          echo "âœ… å·²æˆåŠŸåˆå¹¶çš„åˆ†æ”¯: $MERGED_BRANCHES"
          echo "â­ï¸  è·³è¿‡çš„åˆ†æ”¯: $SKIPPED_BRANCHES"
          echo " "
          echo "ğŸ” å†²çªè¯¦æƒ…:"
          echo "$CONFLICT_DETAILS"
          echo " "
          echo "ğŸ› ï¸ æ‰‹åŠ¨å¤„ç†æ­¥éª¤:"
          echo "1. åˆ‡æ¢åˆ° dev åˆ†æ”¯:"
          echo "   git checkout dev && git pull origin dev"
          echo " "
          echo "2. æ‰‹åŠ¨åˆå¹¶å†²çªåˆ†æ”¯ (é€‰æ‹©ä¸€ç§æ–¹å¼):"
          echo "   a) é€ä¸ªåˆå¹¶å†²çªåˆ†æ”¯:"
          for branch in $CONFLICT_BRANCHES; do
            echo "      git merge origin/$branch"
          done
          echo " "
          echo "   b) æˆ–ä½¿ç”¨ GitHub Desktop/GitKraken ç­‰å·¥å…·"
          echo " "
          echo "3. è§£å†³æ‰€æœ‰å†²çªæ–‡ä»¶:"
          echo "   ç¼–è¾‘æœ‰ <<<<<<<, =======, >>>>>>> æ ‡è®°çš„æ–‡ä»¶"
          echo "   ä¿ç•™éœ€è¦çš„ä»£ç ï¼Œåˆ é™¤å†²çªæ ‡è®°"
          echo " "
          echo "4. æäº¤è§£å†³åçš„ä»£ç :"
          echo "   git add ."
          echo "   git commit -m 'è§£å†³åˆå¹¶å†²çª: $CONFLICT_BRANCHES'"
          echo "   git push origin dev"
          echo " "
          echo "5. é‡æ–°è¿è¡Œæ­¤å·¥ä½œæµ"
          echo "========================================"
          
          # å¯é€‰ï¼šåˆ›å»º issue é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
          # gh issue create --title "åˆå¹¶å†²çªéœ€è¦å¤„ç†" --body "å†²çªåˆ†æ”¯: $CONFLICT_BRANCHES\n\n$CONFLICT_DETAILS" --label "conflict"
          
          exit 1

      - name: No branches notification
        if: steps.get-branches.outputs.branch_count == '0'
        run: |
          echo "ğŸ“­ æ²¡æœ‰æ‰¾åˆ°éœ€è¦åˆå¹¶çš„åˆ†æ”¯"
          
          # å¦‚æœ dev åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„ï¼ˆåŸºäº mainï¼‰
          if [ "${{ steps.prepare-dev.outputs.use_existing_dev }}" = "false" ]; then
            echo "åˆ›å»ºç©ºçš„ dev åˆ†æ”¯..."
            git push -u origin dev
            echo "âœ… å·²åˆ›å»º dev åˆ†æ”¯ï¼ˆæ—  feature å†…å®¹ï¼‰"
          else
            echo "â„¹ï¸ dev åˆ†æ”¯å·²å­˜åœ¨ï¼Œæ— éœ€æ“ä½œ"
          fi
