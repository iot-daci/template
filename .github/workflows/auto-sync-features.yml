name: Auto Sync Feature to Dev

on:
  workflow_call:
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  sync-feature-to-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "Auto Merge Bot"
          git config user.email "auto-merge@users.noreply.github.com"

      - name: Get current branch info
        run: |
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "è§¦å‘æäº¤: ${{ github.sha }}"

      - name: Check if already merged
        id: check-merged
        run: |
          # æ£€æŸ¥æ˜¯å¦å·²ç»åˆå¹¶åˆ° dev
          git fetch origin dev
          if git merge-base --is-ancestor ${{ github.sha }} origin/dev; then
            echo "âœ… å½“å‰æäº¤å·²ç»åˆå¹¶åˆ° dev åˆ†æ”¯ï¼Œè·³è¿‡"
            echo "already_merged=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ éœ€è¦åˆå¹¶åˆ° dev åˆ†æ”¯"
            echo "already_merged=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge to dev
        if: steps.check-merged.outputs.already_merged == 'false'
        run: |
          CURRENT_BRANCH="${{ github.ref_name }}"
          
          echo "æ­£åœ¨å°† $CURRENT_BRANCH åˆå¹¶åˆ° dev..."
          
          # æ›´æ–° dev åˆ†æ”¯
          git checkout dev
          git pull origin dev
          
          # å°è¯•åˆå¹¶
          if git merge origin/$CURRENT_BRANCH --no-ff -m "Auto-merge: $CURRENT_BRANCH â†’ dev [skip ci]"; then
            echo "âœ… åˆå¹¶æˆåŠŸï¼Œæ¨é€æ›´æ”¹"
            git push origin dev
            echo "ğŸ‰ $CURRENT_BRANCH å·²è‡ªåŠ¨åˆå¹¶åˆ° dev åˆ†æ”¯"
          else
            echo "âŒ åˆå¹¶å†²çªï¼Œåˆ›å»º PR æé†’"
            git merge --abort
            
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒ PR
            EXISTING_PR=$(gh pr list --base dev --head $CURRENT_BRANCH --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
            
            if [ -z "$EXISTING_PR" ]; then
              gh pr create \
                --base dev \
                --head $CURRENT_BRANCH \
                --title "ğŸš¨ Merge Conflict: $CURRENT_BRANCH â†’ dev" \
                --body "## è‡ªåŠ¨åˆå¹¶å¤±è´¥\n\nåˆ†æ”¯ **$CURRENT_BRANCH** æ— æ³•è‡ªåŠ¨åˆå¹¶åˆ° devï¼Œè¯·æ‰‹åŠ¨è§£å†³å†²çªã€‚\n\n**å†²çªæ–‡ä»¶:**\n\`\`\`\n$(git status --porcelain)\n\`\`\`\n\n**è§£å†³æ–¹æ¡ˆ:**\n1. åœ¨æœ¬åœ°åˆ‡æ¢åˆ° dev åˆ†æ”¯: \`git checkout dev && git pull\`\n2. åˆå¹¶ feature åˆ†æ”¯: \`git merge origin/$CURRENT_BRANCH\`\n3. è§£å†³å†²çªåæäº¤å¹¶æ¨é€" \
                --label "conflict,needs-attention"
              echo "ğŸ“ å·²åˆ›å»ºå†²çªæé†’ PR"
            else
              echo "ğŸ“ å†²çª PR å·²å­˜åœ¨: #$EXISTING_PR"
            fi
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success notification
        if: steps.check-merged.outputs.already_merged == 'false'
        run: |
          echo "âœ¨ è‡ªåŠ¨åŒæ­¥å®Œæˆ"
          echo "åˆ†æ”¯: ${{ github.ref_name }} â†’ dev"
          echo "æäº¤: ${{ github.sha }}"
          echo "æ—¶é—´: $(date)"
