name: Auto Sync All Features to Dev

on:
  workflow_call:
    secrets:
      GH_TOKEN:
        required: true

jobs:
  rebuild-dev-from-features:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "Dev Rebuilder"
          git config user.email "dev-rebuilder@users.noreply.github.com"
          echo ${{ secrets.GH_TOKEN }} | gh auth login --with-token

      - name: Get all feature branches
        id: get-features
        run: |
          # 获取所有远程 feature-* 分支
          git fetch origin
          FEATURE_BRANCHES=$(git branch -r | grep -E 'origin/feature-' | sed 's/origin\///' | tr '\n' ' ')
          
          if [ -z "$FEATURE_BRANCHES" ]; then
            echo "没有找到 feature-* 分支"
            echo "feature_count=0" >> $GITHUB_OUTPUT
            echo "feature_list=" >> $GITHUB_OUTPUT
          else
            FEATURE_COUNT=$(echo "$FEATURE_BRANCHES" | wc -w)
            echo "找到 $FEATURE_COUNT 个 feature 分支: $FEATURE_BRANCHES"
            echo "feature_count=$FEATURE_COUNT" >> $GITHUB_OUTPUT
            echo "feature_list=$FEATURE_BRANCHES" >> $GITHUB_OUTPUT
          fi

      - name: Check if dev exists
        id: check-dev
        run: |
          # 检查 dev 分支是否存在
          if git ls-remote --exit-code --heads origin dev; then
            echo "dev 分支存在"
            echo "dev_exists=true" >> $GITHUB_OUTPUT
          else
            echo "dev 分支不存在"
            echo "dev_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Recreate or update dev branch
        env:
          FEATURE_BRANCHES: ${{ steps.get-features.outputs.feature_list }}
          DEV_EXISTS: ${{ steps.check-dev.outputs.dev_exists }}
        run: |
          echo "🔄 开始重新构建 dev 分支..."
          
          # 确保 main 分支是最新的
          git checkout main
          git pull origin main
          
          if [ "$DEV_EXISTS" = "true" ]; then
            echo "dev 分支存在，删除并重新创建..."
            
            # 删除本地 dev
            git branch -D dev 2>/dev/null || true
            
            # 删除远程 dev
            git push origin --delete dev 2>/dev/null || echo "删除远程 dev 失败"
          fi
          
          # 从 main 创建新的 dev 分支
          git checkout -b dev
          
          echo "✅ 已创建新的 dev 分支（基于最新 main）"
          
          # 如果没有 feature 分支，直接推送空的 dev
          if [ -z "$FEATURE_BRANCHES" ]; then
            echo "没有 feature 分支需要合并"
            git push -u origin dev
            echo "🎉 dev 分支已创建（无 feature 内容）"
            exit 0
          fi

      - name: Merge all feature branches
        if: steps.get-features.outputs.feature_count != '0'
        id: merge-features
        env:
          FEATURE_BRANCHES: ${{ steps.get-features.outputs.feature_list }}
        run: |
          echo "🔄 合并所有 feature 分支到 dev..."
          echo "要合并的分支: $FEATURE_BRANCHES"
          
          MERGE_SUCCESS="true"
          CONFLICT_BRANCHES=""
          CONFLICT_DETAILS=""
          
          for branch in $FEATURE_BRANCHES; do
            echo "--------------------------------------------------"
            echo "📦 合并分支: $branch"
            
            # 确保获取最新的分支
            git fetch origin $branch
            
            # 尝试合并
            if git merge origin/$branch --no-ff -m "Auto-merge: $branch → dev"; then
              echo "✅ $branch 合并成功"
            else
              echo "❌ $branch 合并冲突"
              MERGE_SUCCESS="false"
              CONFLICT_BRANCHES="$CONFLICT_BRANCHES $branch"
              
              # 记录冲突文件
              CONFLICT_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "无法获取冲突文件")
              CONFLICT_DETAILS="$CONFLICT_DETAILS\n### $branch 的冲突文件:\n\`\`\`\n$CONFLICT_FILES\n\`\`\`\n"
              
              echo "冲突文件: $CONFLICT_FILES"
              
              # 中止合并
              git merge --abort
            fi
          done
          
          echo "merge_success=$MERGE_SUCCESS" >> $GITHUB_OUTPUT
          echo "conflict_branches=$CONFLICT_BRANCHES" >> $GITHUB_OUTPUT
          
          if [ "$MERGE_SUCCESS" = "true" ]; then
            echo "🎉 所有 feature 分支合并成功！"
          else
            echo "⚠️ 部分分支合并时发生冲突"
          fi

      - name: Push dev branch
        if: steps.get-features.outputs.feature_count != '0' && steps.merge-features.outputs.merge_success == 'true'
        run: |
          echo "🚀 推送新的 dev 分支..."
          git push -u origin dev --force
          
          echo "✨ dev 分支重建完成"
          echo "基于分支: main"
          echo "合并的 feature 分支: ${{ steps.get-features.outputs.feature_list }}"
          echo "时间: $(date)"

      - name: Handle merge conflicts
        if: steps.get-features.outputs.feature_count != '0' && steps.merge-features.outputs.merge_success == 'false'
        env:
          CONFLICT_BRANCHES: ${{ steps.merge-features.outputs.conflict_branches }}
          FEATURE_LIST: ${{ steps.get-features.outputs.feature_list }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "📝 处理合并冲突..."
          
          # 提交当前状态（包含部分合并）
          git add .
          git commit -m "WIP: Partial merge with conflicts" || echo "无内容可提交"
          
          # 推送到冲突分支
          CONFLICT_BRANCH="dev-conflict-$(date +%s)"
          git checkout -b $CONFLICT_BRANCH
          git push -u origin $CONFLICT_BRANCH
          
          # 删除不完整的 dev 分支
          git push origin --delete dev 2>/dev/null || echo "远程 dev 分支不存在"
          
          # 创建 PR 报告冲突
          gh pr create \
            --base main \
            --head $CONFLICT_BRANCH \
            --title "🚨 Merge Conflicts in Feature Branches" \
            --body "## 自动合并失败\n\n以下 feature 分支合并时发生冲突：\n\n**冲突分支：**\n- $(echo $CONFLICT_BRANCHES | sed 's/ /\n- /g')\n\n**所有尝试合并的分支：**\n- $(echo $FEATURE_LIST | sed 's/ /\n- /g')\n\n**说明：**\n1. dev 分支已删除（因为合并不完整）\n2. 请解决冲突后将此分支重命名为 dev\n3. 或者手动合并冲突分支到 main" \
            --label "needs-attention"
          
          echo "⚠️ 由于合并冲突，dev 分支未更新"
          echo "已创建冲突处理分支: $CONFLICT_BRANCH"
          echo "冲突分支: $CONFLICT_BRANCHES"
          exit 1
          
